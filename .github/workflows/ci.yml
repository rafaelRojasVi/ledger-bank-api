# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  MIX_ENV: test
  DB_HOST: localhost
  DB_USER: postgres
  DB_PASS: postgres
  DB_NAME: ledger_bank_api_test
  JWT_SECRET: "test-secret-key-for-testing-only-must-be-64-chars-long"
  HEX_HTTP_TIMEOUT: 20

jobs:
  # Job 1: Code Quality Checks (fast, runs first)
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: |
            ~/.mix
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}

      - uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18.4'
          otp-version: '26.2'

      - name: Install dependencies
        run: mix deps.get

      - name: Check formatting
        run: mix format --check-formatted

      - name: Compile with warnings as errors
        run: mix compile --warnings-as-errors

  # Job 2: Tests (runs in parallel with code-quality)
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ledger_bank_api_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: |
            ~/.mix
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}

      - uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18.4'
          otp-version: '26.2'

      - name: Install dependencies
        run: mix deps.get

      - name: Setup database
        run: |
          mix ecto.create
          mix ecto.migrate

      - name: Run tests
        run: mix test --warnings-as-errors

  # Job 3: Docker Build & Health Check (only on main branch or PRs)
  docker-build:
    name: Docker Build & Health Check
    runs-on: ubuntu-latest
    needs: [code-quality, test]  # Only run if tests pass
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services
        run: |
          docker compose up -d db redis
          timeout 60 bash -c 'until docker compose ps db | grep -q "healthy"; do sleep 2; done'
          timeout 60 bash -c 'until docker compose ps redis | grep -q "healthy"; do sleep 2; done'

      - name: Build and test Docker image
        run: |
          echo "Building Docker image..."
          docker compose build web

      - name: Test container health
        run: |
          echo "Starting web container..."
          docker compose up -d web
          
          echo "Waiting for application to be ready..."
          for i in {1..30}; do
            if curl -fsS http://localhost:4000/api/health >/dev/null 2>&1; then
              echo "✅ Application is healthy!"
              docker compose logs --no-color --tail=20 web
              exit 0
            fi
            echo "Attempt $i/30: Waiting for health endpoint..."
            sleep 2
          done
          
          echo "❌ Application did not become ready"
          docker compose logs --no-color --tail=100 web
          exit 1

      - name: Cleanup
        if: always()
        run: docker compose down -v

  # Optional: Build artifacts for releases (only on tags)
  build-release:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    needs: [code-quality, test]
    if: startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: |
            ~/.mix
            deps
            _build
          key: ${{ runner.os }}-mix-${{ hashFiles('**/mix.lock') }}

      - uses: erlef/setup-beam@v1
        with:
          elixir-version: '1.18.4'
          otp-version: '26.2'

      - name: Install dependencies
        run: mix deps.get

      - name: Build release
        env:
          MIX_ENV: prod
        run: mix release

      - name: Upload release artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ github.ref_name }}
          path: _build/prod/rel/ledger_bank_api
          retention-days: 30
